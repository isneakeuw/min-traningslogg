<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Träningslogg</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #212121;
            color: #e0e0e0;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23333333' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zm1 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary:before { content: "►"; float: left; margin-right: 0.5em; transition: transform 0.2s ease; }
        details[open] > summary:before { transform: rotate(90deg); }
        .styled-table { border-collapse: collapse; width: 100%; }
        .styled-table th, .styled-table td { padding: 8px 10px; border: 1px solid #333; text-align: center; }
        .styled-table th:first-child, .styled-table td:first-child { text-align: left; }
        .styled-table thead th { background-color: #333; color: #d1e2f8; font-weight: bold; }
        .styled-table tbody tr:hover { background-color: #333; }
        .editable-cell input[type="number"] { font-family: 'Roboto', sans-serif; font-size: 14px; background-color: transparent; color: inherit; border: none; outline: none; text-align: center; padding: 0; width: 100%; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 150px; }
        .modal-content { background-color: #2e2e2e; margin: auto; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; text-align: center; }
        .modal-buttons { display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
        .modal-buttons button { padding: 10px 20px; border-radius: 8px; font-weight: bold; transition: background-color 0.3s; }
        .modal-buttons .confirm { background-color: #ef4444; color: white; }
        .modal-buttons .cancel { background-color: #4b5563; color: white; }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
    <div id="app-container" class="w-full max-w-lg bg-[#2e2e2e] rounded-2xl shadow-2xl p-6 sm:p-8">
        <header id="app-header" class="mb-6 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-1 text-[#d1e2f8]">Träningslogg</h1>
            <div id="auth-container" class="mt-4"></div>
        </header>

        <div id="login-view" class="text-center py-10">
            <p class="mb-4 text-lg">Välkommen! Logga in för att spara och se din träningsdata.</p>
            <button id="login-button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-lg inline-flex items-center">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039L38.804 12.31C34.886 8.796 29.825 6.5 24 6.5C13.253 6.5 4.5 15.253 4.5 26S13.253 45.5 24 45.5s19.5-8.747 19.5-19.5c0-1.393-.14-2.744-.389-4.083z"/></svg>
                Logga in med Google
            </button>
        </div>

        <div id="main-content" class="hidden">
            <div class="bg-[#333] p-5 rounded-xl mb-6 shadow-xl">
                 <h3 class="text-lg font-semibold mb-4 text-[#d1e2f8]">Ny inmatning</h3>
                <div class="flex flex-col space-y-4">
                    <select id="exercise-select" class="bg-[#212121] text-white p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-[#5cb85c]"></select>
                    <div class="grid grid-cols-[0.8fr_1fr_1fr_1.5fr] gap-4">
                        <div><label for="week-input" class="text-gray-400 text-sm font-semibold">Vecka</label><input type="number" id="week-input" class="bg-[#212121] text-white p-3 rounded-lg w-full mt-1 focus:outline-none focus:ring-2 focus:ring-[#5cb85c]" min="1"></div>
                        <div><label for="sets-input" class="text-gray-400 text-sm font-semibold">Sets</label><input type="number" id="sets-input" class="bg-[#212121] text-white p-3 rounded-lg w-full mt-1 focus:outline-none focus:ring-2 focus:ring-[#5cb85c]" min="1"></div>
                        <div><label for="reps-input" class="text-gray-400 text-sm font-semibold">Reps</label><input type="number" id="reps-input" class="bg-[#212121] text-white p-3 rounded-lg w-full mt-1 focus:outline-none focus:ring-2 focus:ring-[#5cb85c]" min="1"></div>
                        <div><label for="weight-input" class="text-gray-400 text-sm font-semibold">Vikt (kg)</label><input type="number" id="weight-input" class="bg-[#212121] text-white p-3 rounded-lg w-full mt-1 focus:outline-none focus:ring-2 focus:ring-[#5cb85c]" min="0.1" step="0.1"></div>
                    </div>
                </div>
                <button id="save-button" class="mt-4 w-full bg-[#5cb85c] text-white font-bold py-3 px-4 rounded-xl hover:bg-[#4a904a] transition-all">Spara</button>
                 <div id="status-message" class="text-center text-red-400 mt-4 h-6"></div>
            </div>

            <details id="manage-exercises-details" class="bg-[#333] p-5 rounded-xl mb-6 shadow-xl">
                <summary class="text-lg font-semibold text-[#d1e2f8]">Hantera Övningar</summary>
                <div class="flex flex-col sm:flex-row gap-4 my-4">
                    <input type="text" id="new-exercise-input" placeholder="Lägg till ny övning" class="bg-[#212121] text-white p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-[#5cb85c]">
                    <button id="add-exercise-button" class="bg-[#5cb85c] text-white font-bold py-3 px-4 rounded-xl hover:bg-[#4a904a] transition-all sm:w-auto">Lägg till</button>
                </div>
                <div id="exercise-list" class="space-y-2"></div>
            </details>

            <div class="bg-[#333] p-5 rounded-xl shadow-xl">
                <h3 class="text-lg font-semibold mb-4 text-[#d1e2f8]" id="table-title">Vecka </h3>
                <div class="mb-4">
                    <label for="past-weeks-select" class="text-gray-400 text-sm font-semibold">Välj vecka att visa:</label>
                    <select id="past-weeks-select" class="bg-[#212121] text-white p-2 rounded-lg w-full mt-2 focus:outline-none focus:ring-2 focus:ring-[#5cb85c]"></select>
                </div>
                <p id="table-instruction" class="text-sm text-gray-400 mb-4">Klicka på en cell för att redigera dess värde.</p>
                <div id="table-container" class="overflow-x-auto">
                    <table class="styled-table w-full text-sm">
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div id="chart-container" class="hidden h-80 mt-4">
                    <canvas id="weightChart"></canvas>
                </div>
                <div id="data-list-empty-message" class="text-center text-gray-400 mt-4 hidden">Ingen data sparad ännu.</div>
            </div>
        </div>
    
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <h4 class="text-xl font-bold mb-4" id="modal-title">Bekräfta borttagning</h4>
                <p id="modal-message"></p>
                <div class="modal-buttons">
                    <button class="confirm" id="confirm-delete">Ta bort</button>
                    <button class="cancel" id="cancel-delete">Avbryt</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, getDocs, deleteDoc, doc, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginView = document.getElementById('login-view');
        const mainContent = document.getElementById('main-content');
        const loginButton = document.getElementById('login-button');
        const authContainer = document.getElementById('auth-container');
        
        const exerciseSelect = document.getElementById('exercise-select');
        const weekInput = document.getElementById('week-input');
        const pastWeeksSelect = document.getElementById('past-weeks-select');
        const setsInput = document.getElementById('sets-input');
        const repsInput = document.getElementById('reps-input');
        const weightInput = document.getElementById('weight-input');
        const saveButton = document.getElementById('save-button');
        const newExerciseInput = document.getElementById('new-exercise-input');
        const addExerciseButton = document.getElementById('add-exercise-button');
        const exerciseListDiv = document.getElementById('exercise-list');
        const tableBody = document.getElementById('table-body');
        const tableHead = document.getElementById('table-head');
        const modal = document.getElementById('confirmationModal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');
        const tableTitle = document.getElementById('table-title');
        const statusMessageDiv = document.getElementById('status-message');
        const tableContainer = document.getElementById('table-container');
        const chartContainer = document.getElementById('chart-container');
        const dataListEmptyMessage = document.getElementById('data-list-empty-message');
        const weightChart = document.getElementById('weightChart');
        const manageExercisesDetails = document.getElementById('manage-exercises-details');
        
        let myChart = null;
        let entryToDelete = null;
        let hasTyped = false;
        let unsubscribeExercises = null;
        let unsubscribeWorkouts = null;
        
        const defaultExercises = ["Knäböj", "Bänkpress", "Marklyft", "Militärpress", "Skivstångsrodd", "Chins"];
        
        const sanitizeIntegerInput = (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); };
        const sanitizeWeightInput = (e) => {
            let val = e.target.value.replace(/[^0-9,.]/g, '');
            const parts = val.split(/[.,]/);
            if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
            else if (val.includes(',')) val = val.replace(',', '.');
            e.target.value = val;
        };
        
        weekInput.addEventListener('input', sanitizeIntegerInput);
        setsInput.addEventListener('input', sanitizeIntegerInput);
        repsInput.addEventListener('input', sanitizeIntegerInput);
        weightInput.addEventListener('input', sanitizeWeightInput);
        newExerciseInput.addEventListener('input', () => { hasTyped = true; });
        manageExercisesDetails.addEventListener('toggle', () => { if (!manageExercisesDetails.open) hasTyped = false; });
        
        const getWeekNumber = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        const showLoginState = () => {
            loginView.classList.remove('hidden');
            mainContent.classList.add('hidden');
            authContainer.innerHTML = '';
        };

        const showAppLayout = (user) => {
            loginView.classList.add('hidden');
            mainContent.classList.remove('hidden');
            authContainer.innerHTML = `
                <div class="flex items-center justify-center gap-4">
                     <p class="text-sm text-gray-300">Inloggad som ${user.displayName || user.email || user.uid}</p>
                     <button id="logout-button" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-all">Logga ut</button>
                </div>`;
            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        };
        
        const cleanupListeners = () => {
            if (unsubscribeExercises) unsubscribeExercises();
            if (unsubscribeWorkouts) unsubscribeWorkouts();
        };

        const setupApp = (user) => {
            cleanupListeners();
            showAppLayout(user);

            weekInput.value = getWeekNumber(new Date());

            const workoutDataPath = `artifacts/${appId}/users/${user.uid}/workout-data`;
            const exercisesPath = `artifacts/${appId}/users/${user.uid}/exercises`;
            const exercisesCollectionRef = collection(db, exercisesPath);

            getDocs(exercisesCollectionRef).then(snapshot => {
                if (snapshot.empty) {
                    defaultExercises.forEach(name => addDoc(exercisesCollectionRef, { name }));
                }
            });

            unsubscribeExercises = onSnapshot(exercisesCollectionRef, (snapshot) => {
                const exercises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name));
                exerciseSelect.innerHTML = '';
                exerciseListDiv.innerHTML = '';
                exercises.forEach(ex => {
                    exerciseSelect.innerHTML += `<option value="${ex.name}">${ex.name}</option>`;
                    exerciseListDiv.innerHTML += `<div class="flex justify-between items-center bg-[#212121] p-3 rounded-lg"><span class="truncate">${ex.name}</span><button data-id="${ex.id}" class="remove-exercise-button bg-red-500 text-white px-2 py-1 rounded-full text-xs">X</button></div>`;
                });
            });

            let lastAddedWeek = null;
            unsubscribeWorkouts = onSnapshot(query(collection(db, workoutDataPath)), (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const uniqueWeeks = [...new Set(data.map(item => item.week))].sort((a, b) => b - a);
                
                const currentWeekSelection = pastWeeksSelect.value;
                populateWeekDropdown(uniqueWeeks);
                
                let weekToSelect = currentWeekSelection;
                if (lastAddedWeek) weekToSelect = lastAddedWeek.toString();
                else if (!uniqueWeeks.includes(parseInt(currentWeekSelection))) weekToSelect = 'all';

                pastWeeksSelect.value = weekToSelect;
                lastAddedWeek = null;
                
                if (weekToSelect === 'all') renderChart(data);
                else renderTable(data, weekToSelect);
            });

            saveButton.onclick = async () => {
                const exercise = exerciseSelect.value;
                const week = parseInt(weekInput.value);
                const weight = parseFloat(weightInput.value.trim().replace(',', '.'));
                const sets = setsInput.value.trim() ? parseInt(setsInput.value) : null;
                const reps = repsInput.value.trim() ? parseInt(repsInput.value) : null;

                if (!exercise || isNaN(week) || week <= 0 || isNaN(weight) || weight <= 0) {
                    statusMessageDiv.textContent = "Fyll i alla fält korrekt.";
                    statusMessageDiv.classList.add('text-red-400');
                    return;
                }
                
                await addDoc(collection(db, workoutDataPath), { exercise, week, sets, reps, weight, timestamp: serverTimestamp() });
                lastAddedWeek = week;
                statusMessageDiv.textContent = "Data sparad!";
                statusMessageDiv.classList.add('text-green-400');
                [setsInput, repsInput, weightInput].forEach(i => i.value = '');
            };

            addExerciseButton.onclick = async () => {
                const newExerciseName = newExerciseInput.value.trim();
                if (newExerciseName) {
                    await addDoc(collection(db, exercisesPath), { name: newExerciseName });
                    newExerciseInput.value = '';
                }
            };
        };
        
        onAuthStateChanged(auth, user => {
            if (user) {
                setupApp(user);
            } else {
                showLoginState();
            }
        });

        const provider = new GoogleAuthProvider();
        loginButton.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then(() => {
                    // Sign-in successful. Handled by onAuthStateChanged.
                })
                .catch((error) => {
                    console.error("Google sign-in failed:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        console.error("Error: Firebase is blocking sign-in from this domain. Please add this domain to the authorized domains in your Firebase Console under Authentication > Settings > Authorized domains.");
                    }
                });
        });

        const setupModal = (type, id, name) => {
            entryToDelete = { type, id, name, uid: auth.currentUser.uid };
            modal.querySelector('#modal-message').textContent = type === 'exercise'
                ? `Vill du ta bort "${name}"? All data för övningen raderas.`
                : `Vill du ta bort denna inmatning?`;
            modal.style.display = 'block';
        };

        exerciseListDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-exercise-button')) {
                const name = e.target.parentElement.querySelector('span').textContent;
                setupModal('exercise', e.target.dataset.id, name);
            }
        });

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-entry-button')) {
                setupModal('data', e.target.dataset.docId, null);
            } else if (e.target.classList.contains('editable-cell') && !e.target.querySelector('input')) {
                const cell = e.target;
                const { type: cellType, docId } = cell.dataset;
                const oldValue = cell.textContent.trim();
                cell.innerHTML = `<input type="number" class="w-full bg-gray-700 text-center" value="${oldValue !== '-' ? oldValue.replace(',', '.') : ''}" ${cellType === 'weight' ? 'step="0.1"' : ''}>`;
                const input = cell.querySelector('input');
                input.focus();
                
                const saveUpdate = async () => {
                    let newValue = input.value.trim().replace(',', '.');
                    newValue = newValue === '' ? null : (cellType === 'weight' ? parseFloat(newValue) : parseInt(newValue));
                    if (String(newValue) !== oldValue) {
                         await updateDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/workout-data`, docId), { [cellType]: newValue });
                    }
                    cell.innerHTML = oldValue;
                };
                input.addEventListener('blur', saveUpdate);
                input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); });
            }
        });
        
        confirmDeleteButton.onclick = async () => {
            if (!entryToDelete) return;
            const { type, id, name, uid } = entryToDelete;
            if (type === 'exercise') {
                const q = query(collection(db, `artifacts/${appId}/users/${uid}/workout-data`), where("exercise", "==", name));
                const snapshot = await getDocs(q);
                await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
                await deleteDoc(doc(db, `artifacts/${appId}/users/${uid}/exercises`, id));
            } else {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${uid}/workout-data`, id));
            }
            modal.style.display = 'none';
        };
        
        cancelDeleteButton.onclick = () => { modal.style.display = 'none'; };
        
        pastWeeksSelect.addEventListener('change', async () => {
            const selectedWeek = pastWeeksSelect.value;
            const snapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/workout-data`)));
            const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            if (selectedWeek === 'all') renderChart(data);
            else renderTable(data, selectedWeek);
        });

        const populateWeekDropdown = (weeks) => {
            const currentVal = pastWeeksSelect.value;
            pastWeeksSelect.innerHTML = '<option value="all">Alla veckor</option>';
            weeks.forEach(week => pastWeeksSelect.innerHTML += `<option value="${week}">Vecka ${week}</option>`);
            pastWeeksSelect.value = currentVal;
        };

        const renderTable = (data, selectedWeek) => {
            chartContainer.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            tableHead.innerHTML = '<tr><th class="rounded-tl-lg">Övning</th><th>Sets</th><th>Reps</th><th>Vikt (kg)</th><th class="rounded-tr-lg"></th></tr>';
            tableBody.innerHTML = '';
            
            const filtered = data.filter(item => item.week === parseInt(selectedWeek));
            tableTitle.textContent = `Vecka ${selectedWeek}`;
            dataListEmptyMessage.classList.toggle('hidden', filtered.length > 0);
            if(filtered.length === 0) return;

            const exercises = [...new Set(filtered.map(item => item.exercise))].sort();
            exercises.forEach(ex => {
                const latest = filtered.filter(item => item.exercise === ex).reduce((a, b) => (a.timestamp.seconds > b.timestamp.seconds) ? a : b);
                tableBody.innerHTML += `<tr><td>${ex}</td><td class="editable-cell" data-type="sets" data-doc-id="${latest.id}">${latest.sets ?? '-'}</td><td class="editable-cell" data-type="reps" data-doc-id="${latest.id}">${latest.reps ?? '-'}</td><td class="editable-cell" data-type="weight" data-doc-id="${latest.id}">${latest.weight}</td><td><button data-doc-id="${latest.id}" class="delete-entry-button bg-red-500 text-white px-2 py-1 text-xs rounded-full">X</button></td></tr>`;
            });
        };

        const renderChart = (data) => {
            tableContainer.classList.add('hidden');
            chartContainer.classList.remove('hidden');
            tableTitle.textContent = 'Träningsframsteg';
            dataListEmptyMessage.classList.toggle('hidden', data.length > 0);
            if (myChart) myChart.destroy();
            if(data.length === 0) return;

            const grouped = data.reduce((acc, entry) => { (acc[entry.week] = acc[entry.week] || {})[entry.exercise] = (acc[entry.week][entry.exercise] || []).concat(entry); return acc; }, {});
            const weeks = Object.keys(grouped).sort((a, b) => a - b);
            const exercises = [...new Set(data.map(item => item.exercise))].sort();
            const datasets = exercises.map(ex => ({
                label: ex,
                data: weeks.map(w => grouped[w][ex] ? grouped[w][ex].reduce((a, b) => (a.timestamp.seconds > b.timestamp.seconds) ? a : b).weight : null),
                borderColor: `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`,
                tension: 0.1, fill: false, spanGaps: true
            }));

            myChart = new Chart(weightChart, {
                type: 'line', data: { labels: weeks.map(w => `Vecka ${w}`), datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#e0e0e0' }}}, scales: { x: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(255,255,255,0.1)' }, title: { display: true, text: 'Vecka', color: '#d1e2f8' }}, y: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(255,255,255,0.1)' }, title: { display: true, text: 'Vikt (kg)', color: '#d1e2f8' }}}}
            });
        };
    </script>
</body>
</html>
